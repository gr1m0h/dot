#!/bin/bash
set -euo pipefail

echo "Installing packages from Brewfile..."

# Ensure brew is available
if ! command -v brew &>/dev/null; then
    echo "Error: Homebrew is not installed"
    exit 1
fi

# Check if Brewfile exists
echo "Debug: Looking for Brewfile at $HOME/Brewfile"
echo "Debug: Contents of home directory:"
ls -la "$HOME/" | grep -E "(Brewfile|\.)"
if [ ! -f "$HOME/Brewfile" ]; then
    echo "No Brewfile found at $HOME/Brewfile"
    echo "Waiting for chezmoi to apply files (avoiding lock conflicts)..."
    
    # Wait up to 30 seconds for Brewfile to appear
    for i in {1..30}; do
        if [ -f "$HOME/Brewfile" ]; then
            echo "Brewfile found after ${i} seconds"
            break
        fi
        echo "Waiting... (${i}/30)"
        sleep 1
    done
    
    if [ ! -f "$HOME/Brewfile" ]; then
        echo "Brewfile still not found after 30 seconds, skipping package installation"
        echo "Note: This may be due to chezmoi configuration issues"
        exit 0
    fi
fi

# Install from Brewfile
brew bundle --file="$HOME/Brewfile"

echo "Homebrew packages installed successfully!"