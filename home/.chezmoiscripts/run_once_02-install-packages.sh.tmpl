#!/bin/bash
set -euo pipefail

echo "Installing packages from Brewfile..."

# Ensure brew is available
if ! command -v brew &>/dev/null; then
    echo "Error: Homebrew is not installed"
    exit 1
fi

# Check if Brewfile exists
echo "Debug: Looking for Brewfile at $HOME/Brewfile"
echo "Debug: Contents of home directory:"
ls -la "$HOME/" | grep -E "(Brewfile|\.)"
if [ ! -f "$HOME/Brewfile" ]; then
    echo "No Brewfile found at $HOME/Brewfile, skipping Homebrew packages installation"
    echo "Debug: Checking chezmoi status:"
    chezmoi status || echo "chezmoi status failed"
    echo "Debug: Checking if chezmoi managed the Brewfile:"
    chezmoi managed | grep -i brewfile || echo "No Brewfile in chezmoi managed files"
    echo "Debug: Force applying chezmoi:"
    chezmoi apply --force || echo "chezmoi apply failed"
    echo "Debug: Checking again for Brewfile:"
    ls -la "$HOME/Brewfile" 2>/dev/null || echo "Still no Brewfile after apply"
    if [ ! -f "$HOME/Brewfile" ]; then
        exit 0
    fi
fi

# Install from Brewfile
brew bundle --file="$HOME/Brewfile"

echo "Homebrew packages installed successfully!"