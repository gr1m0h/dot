{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash
set -euo pipefail

# Skip in CI environment
if [ -n "${CI:-}" ] || [ -n "${GITHUB_ACTIONS:-}" ]; then
    echo "Skipping macOS configuration in CI environment"
    exit 0
fi

echo "Configuring macOS settings..."

# Get macOS version for compatibility checks
os_version=$(sw_vers -productVersion)
echo "Detected macOS version: $os_version"

# Create workspace directory
mkdir -p "$HOME/Documents/workspace"

# System UI Configuration
echo "Configuring System UI..."
defaults write NSGlobalDomain AppleInterfaceStyle -string "Dark"
defaults write com.apple.universalaccess reduceTransparency -bool true 2>/dev/null || true
defaults write NSGlobalDomain AppleShowScrollBars -string "Always"
defaults write com.apple.LaunchServices LSQuarantine -bool false
defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode -bool true
defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode2 -bool true

# Terminal
echo "Configuring Terminal..."
defaults write com.apple.terminal StringEncodings -array 4

# Safari
echo "Configuring Safari..."
defaults write com.apple.Safari IncludeInternalDebugMenu -bool true 2>/dev/null || true
defaults write com.apple.Safari IncludeDevelopMenu -bool true 2>/dev/null || true
defaults write com.apple.Safari WebKitDeveloperExtrasEnabledPreferenceKey -bool true 2>/dev/null || true
defaults write com.apple.Safari com.apple.Safari.ContentPageGroupIdentifier.WebKit2DeveloperExtrasEnabled -bool true 2>/dev/null || true

# Finder
echo "Configuring Finder..."
defaults write NSGlobalDomain AppleShowAllExtensions -bool true
defaults write com.apple.Finder AppleShowAllFiles -bool false
chflags nohidden ~/Library
defaults write com.apple.finder FXDefaultSearchScope -string "SCcf"
defaults write com.apple.finder ShowPathbar -bool true
defaults write com.apple.finder ShowStatusBar -bool true
defaults write com.apple.finder NewWindowTarget -string "PfDe"
defaults write com.apple.finder FXEnableExtensionChangeWarning -bool false
defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool true
defaults write com.apple.desktopservices DSDontWriteUSBStores -bool true
defaults write com.apple.finder FXPreferredViewStyle -string "Nlsv"
sudo chflags nohidden /Volumes 2>/dev/null || true
defaults write com.apple.finder WarnOnEmptyTrash -bool false

# Dock
echo "Configuring Dock..."
defaults write com.apple.dock orientation bottom
defaults write com.apple.dock mineffect -string "genie"
defaults write com.apple.dock tilesize -int 48
defaults write com.apple.dock largesize -float 94
defaults write com.apple.dock magnification -bool true
defaults write com.apple.dock autohide -bool true
defaults write com.apple.dock show-recents -bool false
defaults write com.apple.dock show-process-indicators -bool true
defaults write com.apple.dock expose-animation-duration -float 0.1
defaults write com.apple.dock mru-spaces -bool false
defaults write com.apple.dock autohide-delay -float 0
defaults write com.apple.dock autohide-time-modifier -float 0.2

# Screenshots
echo "Configuring Screenshot settings..."
defaults write com.apple.screencapture location -string "$HOME/Desktop"
defaults write com.apple.screencapture type -string "png"
defaults write com.apple.screencapture disable-shadow -bool true

# Keyboard
echo "Configuring Keyboard..."
defaults write NSGlobalDomain AppleKeyboardUIMode -int 3
defaults write NSGlobalDomain AppleFontSmoothing -int 2
defaults write NSGlobalDomain ApplePressAndHoldEnabled -bool false
defaults write NSGlobalDomain KeyRepeat -int 2
defaults write NSGlobalDomain InitialKeyRepeat -int 15
defaults write NSGlobalDomain NSAutomaticCapitalizationEnabled -bool false
defaults write NSGlobalDomain NSAutomaticDashSubstitutionEnabled -bool false
defaults write NSGlobalDomain NSAutomaticPeriodSubstitutionEnabled -bool false
defaults write NSGlobalDomain NSAutomaticQuoteSubstitutionEnabled -bool false
defaults write NSGlobalDomain NSAutomaticSpellingCorrectionEnabled -bool false

# Trackpad
echo "Configuring Trackpad..."
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true
defaults write NSGlobalDomain com.apple.mouse.tapBehavior -int 1
defaults write com.apple.AppleMultitouchTrackpad Clicking -bool true
defaults -currentHost write NSGlobalDomain com.apple.mouse.tapBehavior -int 1

# Security
echo "Configuring Security settings..."
defaults write com.apple.screensaver askForPassword -bool true
defaults write com.apple.screensaver askForPasswordDelay -int 0

# Other settings
echo "Configuring other settings..."
defaults write com.apple.menuextra.clock 'DateFormat' -string 'EEE d MMM HH:mm' 2>/dev/null || true
defaults write com.apple.NetworkBrowser BrowseAllInterfaces 1
defaults write com.apple.ActivityMonitor OpenMainWindow -bool true
defaults write com.apple.ActivityMonitor IconType -int 5
defaults write com.apple.ActivityMonitor ShowCategory -int 0
defaults write NSGlobalDomain NSAutomaticWindowAnimationsEnabled -bool false
defaults write NSGlobalDomain NSWindowResizeTime -float 0.001

echo "Restarting affected applications..."
for app in Safari Finder Dock SystemUIServer ActivityMonitor; do
    killall "$app" >/dev/null 2>&1 || true
done

echo "macOS configuration completed!"
echo "Some changes may require a logout/restart to take full effect."
{{- end -}}
