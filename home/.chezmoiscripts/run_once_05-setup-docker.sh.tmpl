#!/bin/bash
set -euo pipefail

# Skip in CI environment
if [ -n "${CI:-}" ] || [ -n "${GITHUB_ACTIONS:-}" ]; then
    echo "Skipping Docker setup in CI environment"
    exit 0
fi

echo "Setting up Docker with Colima..."

# Ensure mise is available
if ! command -v mise &>/dev/null; then
    echo "Error: mise is not installed. mise tools should be installed by previous script."
    exit 1
fi

# Activate mise environment
echo "Activating mise environment..."
eval "$(mise activate bash)"

# Debug mise environment
echo "Debug: mise version: $(mise --version)"
echo "Debug: PATH after mise activate: $PATH"
echo "Debug: mise list:"
mise list || echo "Failed to list mise tools"

# Check if docker and colima are available
echo "Checking for docker command..."
if ! command -v docker &>/dev/null; then
    echo "Docker not found. Debugging mise installation..."
    echo "mise doctor:"
    mise doctor || echo "mise doctor failed"
    echo "Contents of ~/.local/share/mise/installs/:"
    ls -la ~/.local/share/mise/installs/ 2>/dev/null || echo "Directory not found"
    exit 1
fi

if ! command -v colima &>/dev/null; then
    echo "Colima not found. Please ensure mise tools are installed properly."
    echo "Run 'mise install' manually if needed."
    exit 1
fi

# Check for Lima (required by Colima)
if ! command -v limactl &>/dev/null; then
    echo "Lima (limactl) not found. Colima requires Lima to function."
    echo "Checking mise installation..."
    mise list | grep -E "lima|colima" || echo "Lima/Colima not in mise list"
    
    # Try to refresh mise environment
    echo "Refreshing mise environment..."
    eval "$(mise activate bash)"
    
    if ! command -v limactl &>/dev/null; then
        echo "ERROR: Lima is not available after mise activation."
        echo "Please check that Lima is properly installed via mise."
        exit 1
    fi
fi

echo "Docker, Colima, and Lima found via mise. Proceeding with setup..."

# Start Colima if not running
if ! colima status &>/dev/null; then
    echo "Starting Colima with default configuration..."
    
    # Ensure mise environment is properly loaded before starting Colima
    echo "Re-activating mise environment before starting Colima..."
    eval "$(mise activate bash)"
    
    # Double-check that both tools are available
    if ! command -v colima &>/dev/null; then
        echo "ERROR: colima command not found after mise activation"
        exit 1
    fi
    
    if ! command -v limactl &>/dev/null; then
        echo "ERROR: limactl command not found after mise activation"
        echo "Attempting to locate lima installation..."
        find ~/.local/share/mise -name "limactl" 2>/dev/null || echo "limactl not found in mise directory"
        exit 1
    fi
    
    colima start || {
        echo "Failed to start Colima. Please check logs with 'colima logs'"
        echo "Debugging information:"
        echo "- colima version: $(colima --version 2>/dev/null || echo 'unknown')"
        echo "- limactl version: $(limactl --version 2>/dev/null || echo 'unknown')"
        echo "- PATH: $PATH"
        exit 1
    }
fi

# Configure Docker context
echo "Setting up docker context to use colima..."
docker context use colima || {
    echo "Failed to set docker context to colima"
    echo "You can set it manually with 'docker context use colima'"
}

# Create docker socket link (optional, for compatibility)
if [ -S "$HOME/.config/colima/default/docker.sock" ]; then
    echo "Docker socket found. Some tools may require a symlink to /var/run/docker.sock"
    echo "If needed, run: sudo ln -sf $HOME/.config/colima/default/docker.sock /var/run/docker.sock"
fi

echo "Docker setup completed successfully!"