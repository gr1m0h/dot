#!/bin/bash
# This script builds and installs the WezTerm-Nvim AppleScript application
# hash: {{ include "dot_local/share/chezmoi-scripts/WezTerm-Nvim.applescript.tmpl" | sha256sum }}

set -e

# Skip in CI environment or non-macOS systems
if [ -n "${CI:-}" ] || [ -n "${GITHUB_ACTIONS:-}" ] || [ "$(uname)" != "Darwin" ]; then
    echo "Skipping WezTerm-Nvim.app setup (CI environment or non-macOS)"
    exit 0
fi

echo "üöÄ Setting up WezTerm-Nvim.app..."

# Create temp directory for building
TEMP_DIR=$(mktemp -d)
trap "rm -rf $TEMP_DIR" EXIT

# Generate AppleScript from template
APPLESCRIPT_TEMPLATE="${HOME}/.local/share/chezmoi-scripts/WezTerm-Nvim.applescript.tmpl"
APPLESCRIPT_SOURCE="${HOME}/.local/share/chezmoi/home/dot_local/share/chezmoi-scripts/WezTerm-Nvim.applescript.tmpl"

if [ -f "$APPLESCRIPT_TEMPLATE" ]; then
    echo "üìù Using applied template from $APPLESCRIPT_TEMPLATE"
    chezmoi execute-template < "$APPLESCRIPT_TEMPLATE" > "$TEMP_DIR/WezTerm-Nvim.applescript"
elif [ -f "$APPLESCRIPT_SOURCE" ]; then
    echo "üìù Using source template from $APPLESCRIPT_SOURCE (fallback)"
    chezmoi execute-template < "$APPLESCRIPT_SOURCE" > "$TEMP_DIR/WezTerm-Nvim.applescript"
else
    echo "‚ùå AppleScript template not found in either location:"
    echo "  - $APPLESCRIPT_TEMPLATE"
    echo "  - $APPLESCRIPT_SOURCE"
    exit 1
fi

# Build the application
echo "üì¶ Building WezTerm-Nvim.app..."
osacompile -o "$TEMP_DIR/WezTerm-Nvim.app" "$TEMP_DIR/WezTerm-Nvim.applescript"

# Create Applications directory if it doesn't exist
mkdir -p "${HOME}/Applications"

# Remove old version if exists
if [ -d "${HOME}/Applications/WezTerm-Nvim.app" ]; then
    echo "üóëÔ∏è  Removing old version..."
    rm -rf "${HOME}/Applications/WezTerm-Nvim.app"
fi

# Move app to Applications
echo "üìÇ Installing to ~/Applications..."
mv "$TEMP_DIR/WezTerm-Nvim.app" "${HOME}/Applications/"

# Configure file associations using PlistBuddy
echo "‚öôÔ∏è  Configuring file associations..."
APP_PATH="${HOME}/Applications/WezTerm-Nvim.app"
PLIST_PATH="$APP_PATH/Contents/Info.plist"

# Add CFBundleDocumentTypes if it doesn't exist
/usr/libexec/PlistBuddy -c "Delete :CFBundleDocumentTypes" "$PLIST_PATH" 2>/dev/null || true
/usr/libexec/PlistBuddy -c "Add :CFBundleDocumentTypes array" "$PLIST_PATH"

# Define file extensions to associate
EXTENSIONS=(
    # Text files
    "txt" "md" "markdown" "rst"
    # Programming languages
    "lua" "vim" "vimrc"
    "js" "jsx" "ts" "tsx" "mjs" "cjs"
    "py" "pyw" "pyi" "pyc"
    "rb" "rake" "ru" "gemspec"
    "go" "mod" "sum"
    "rs" "toml" 
    "c" "h" "cpp" "hpp" "cc" "cxx"
    "java" "class" "jar"
    "sh" "bash" "zsh" "fish"
    # Config files
    "yml" "yaml" "json" "jsonc" "json5"
    "xml" "plist" "ini" "cfg" "conf"
    "env" "gitignore" "gitconfig"
    "dockerfile" "dockerignore"
    # Web files
    "html" "htm" "css" "scss" "sass" "less"
    "php" "asp" "jsp"
    # Other
    "sql" "graphql" "proto"
    {{- if hasKey . "extra_extensions" }}
    {{- range .extra_extensions }}
    "{{ . }}"
    {{- end }}
    {{- end }}
)

# Add document type
/usr/libexec/PlistBuddy -c "Add :CFBundleDocumentTypes:0 dict" "$PLIST_PATH"
/usr/libexec/PlistBuddy -c "Add :CFBundleDocumentTypes:0:CFBundleTypeExtensions array" "$PLIST_PATH"

# Add all extensions
for i in "${!EXTENSIONS[@]}"; do
    ext="${EXTENSIONS[$i]}"
    /usr/libexec/PlistBuddy -c "Add :CFBundleDocumentTypes:0:CFBundleTypeExtensions:$i string '$ext'" "$PLIST_PATH"
done

# Set document type properties
/usr/libexec/PlistBuddy -c "Add :CFBundleDocumentTypes:0:CFBundleTypeName string 'Text Files'" "$PLIST_PATH"
/usr/libexec/PlistBuddy -c "Add :CFBundleDocumentTypes:0:CFBundleTypeRole string 'Editor'" "$PLIST_PATH"
/usr/libexec/PlistBuddy -c "Add :CFBundleDocumentTypes:0:CFBundleTypeIconFile string 'AppIcon'" "$PLIST_PATH"

# Add bundle identifier
/usr/libexec/PlistBuddy -c "Add :CFBundleIdentifier string 'com.local.wezterm-nvim'" "$PLIST_PATH" 2>/dev/null || \
/usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier 'com.local.wezterm-nvim'" "$PLIST_PATH"

# Add bundle name
/usr/libexec/PlistBuddy -c "Add :CFBundleName string 'WezTerm-Nvim'" "$PLIST_PATH" 2>/dev/null || \
/usr/libexec/PlistBuddy -c "Set :CFBundleName 'WezTerm-Nvim'" "$PLIST_PATH"

# Update LaunchServices database
echo "üîÑ Updating LaunchServices database..."
/System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister -f "${HOME}/Applications/WezTerm-Nvim.app"

echo "‚úÖ WezTerm-Nvim.app setup complete!"
echo ""
echo "üìù Usage:"
echo "  1. Right-click any text file in Finder"
echo "  2. Select 'Open With' > 'WezTerm-Nvim'"
echo "  3. Click 'Change All...' to set as default for that file type"
echo ""
echo "üí° Tip: You can also drag files onto the app icon to open them"