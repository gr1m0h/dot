#!/bin/bash
set -euo pipefail

# Skip in CI environment
if [ -n "${CI:-}" ] || [ -n "${GITHUB_ACTIONS:-}" ]; then
    echo "Skipping mise tools installation in CI environment"
    exit 0
fi

echo "Installing mise tools..."

# Ensure mise is available
if ! command -v mise &>/dev/null; then
    echo "Error: mise is not installed. Please run brew bundle first."
    exit 1
fi

# Wait for mise config to be applied
echo "Waiting for mise configuration file..."
for i in {1..30}; do
    if [ -f "$HOME/.config/mise/config.toml" ]; then
        echo "mise config found after ${i} seconds"
        break
    fi
    echo "Waiting for ~/.config/mise/config.toml... (${i}/30)"
    sleep 1
done

if [ ! -f "$HOME/.config/mise/config.toml" ]; then
    echo "mise config not found after 30 seconds"
    echo "Checking if any mise config exists..."
    mise config || echo "No mise config found"
    echo "Skipping mise tools installation"
    exit 0
fi

echo "mise config found, proceeding with installation"
echo "Config contents:"
head -10 "$HOME/.config/mise/config.toml"

# Install all mise tools
echo "Running mise install..."
mise install

# Activate mise for current shell
eval "$(mise activate bash)"

echo "mise tools installed successfully!"